---
title: nodejsç¿»è¯‘jsæ–‡ä»¶
tags: [obsidian,'#Fleeting_N']
date: 2023-06-22 14:57:59
draft: true
hideInList: false
isTop: false
published: true
categories: [obsidian]
---

- ä½œè€…ï¼šé˜¿ä¸‰
- åšå®¢ï¼š[https://blog.asan123.top](https://blog.asan123.top)
- å…¬ä¼—å·ï¼šé˜¿ä¸‰çˆ±åƒç“œ

> æŒç»­ä¸æ–­è®°å½•ã€æ•´ç†ã€åˆ†äº«ï¼Œè®©è‡ªå·±å’Œä»–äººä¸€èµ·æˆé•¿ï¼ğŸ˜Š

# ä½¿ç”¨ nodeJs å®ç° js/ts æ–‡ä»¶ç¿»è¯‘åŠŸèƒ½

å…³äºå®ç°ç¿»è¯‘(å·²ä¸­ç¿»è‹±ä¸ºä¾‹)çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†æˆå‡ ä¸ªæ­¥éª¤ï¼š

+   è¯»æ–‡ä»¶
+   æ‰¾å‡ºæ–‡ä¸­çš„ä¸­æ–‡
+   å°†æ–‡ä¸­çš„å‡ºç°çš„ä¸­æ–‡è¯ç»„æˆ–è€…å¥å­ç»„æˆä¸€å“¥æ•°ç»„
+   è°ƒç”¨å…¬å…±çš„ç¿»è¯‘æ¥å£è¿›è¡Œå¼‚æ­¥ç¿»è¯‘
+   å°†ç¿»è¯‘å‡ºæ¥çš„è‹±æ–‡å›å¡«ä¼šæ–‡ä»¶ä¸­

## ä¸€ã€æ­å»ºç¯å¢ƒ

æ‰“å¼€ç»ˆç«¯ï¼Œé”®å…¥ï¼š`node -v`

å¦‚æœå‡ºç° `-bash: node: command not found`

è¯´æ˜ `node` çš„ç¯å¢ƒæ²¡æœ‰æ­å»ºã€‚è¯·åˆ°[å®˜ç½‘](http://nodejs.cn/download/)ä¸Šä¸‹è½½ã€‚

å¦‚æœç»ˆç«¯ä¸Šå‡ºç°ï¼š`v10.16.0` ç±»ä¼¼è¿™æ ·çš„ç‰ˆæœ¬å·ï¼Œè¯´æ˜ä½ çš„ `node` ç¯å¢ƒæ­å»ºå¥½å•¦ã€‚

## äºŒã€è¯»æ–‡ä»¶

æˆ‘ä»¬å…ˆè¯»å–å›ºå®šçš„æ–‡ä»¶ï¼Œåé¢æˆ‘ä»¬ä¼šå°è¯•å®ç°ç¿»è¯‘ä¸Šä¼ çš„æ–‡ä»¶ï¼Œæœ‰éœ€è¦çš„å°ä¼™ä¼´å¯ä»¥ç§»æ­¥åˆ°åé¢çš„å†…å®¹ã€‚

é¦–å…ˆæˆ‘ä»¬åœ¨æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºä¸€ä¸ª `replace.js` æ–‡ä»¶ç”¨æ¥ç¼–å†™æˆ‘ä»¬çš„ä»£ç ã€‚

å…¶æ¬¡åˆ›å»ºä¸€ä¸ªä¾›æˆ‘ä»¬ç¿»è¯‘çš„ `js/ts` æ–‡ä»¶ï¼Œå¦‚ï¼š`DesUtils.ts`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```js
const desKeyObj = {
  desKey: 'ztesoftbasemobile20160812..',
  ivKey: '01234567890'
}
export default {
  /**
   * åŠ å¯†
   * @param dataStr
   */
  encrypt: function (dataStr) {
    try {
        console.log("å¦‚æœè¿™æ˜¯ä¸€æ®µè¯ã€‚å¹¶ä¸”è¿˜æœ‰æ ‡ç‚¹ç¬¦å·ã€‚");
    } catch (error) {
        console.log('åŠ å¯†æŠ¥é”™' + JSON.stringify(error));
    }
  },
  /**
   *
   * @param dataStr è§£å¯†
   */
  crypto: function (dataStr) {
    try {
        console.log('');
    } catch (error) {
        console.log('è§£å¯†æŠ¥é”™')
    }
  }
}
```

ç°åœ¨æˆ‘ä»¬å¼€å§‹ç¼–å†™ `replace.js` æ–‡ä»¶ï¼Œæ¥è¯»å– `DesUtil.ts` æ–‡ä»¶ã€‚

é¦–å…ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `require` å‘½ä»¤æ¥å¼•å…¥æˆ‘ä»¬éœ€è¦çš„æ¨¡å—ã€‚

`node` å¯¹äºæ–‡ä»¶çš„è¯»å†™æ“ä½œæ˜¯åŸºäº `Stream` æµçš„å½¢å¼ã€‚

`fs` æ¨¡å—ä¸‹æœ‰å››ç§æµç±»å‹ï¼š

+   Readable - å¯è¯»æ“ä½œ
+   Writable - å¯å†™æ“ä½œ
+   Duplex - å¯è¯»å¯å†™æ“ä½œ
+   Transform - æ“ä½œè¢«å†™å…¥æ•°æ®ï¼Œç„¶åè¯»å‡ºç»“æœ

å¯¹äºæµçš„æ“ä½œä¹Ÿæœ‰å››ç§ï¼š

+   data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘
+   end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘
+   error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘
+   finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘

æ˜¯ä¸æ˜¯çœ‹äº†æœ‰ç‚¹æ‡µå‘¢ï¼Œä¸ç€æ€¥ï¼Œé€šè¿‡ä¸‹é¢çš„ä»£ç ä½ å°±èƒ½ç†è§£ã€‚

åˆ›å»ºå¯è¯»æµï¼Œå¹¶å¤„ç†æµäº‹ä»¶ï¼š

```js
// åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('DesUtils.ts');
readerStream.setEncoding('UTF8');

let data = '';

// å¤„ç†æµ
readerStream.on('data', (chunk) =%3E {
   data += chunk;
});

readerStream.on('end',() => {
   console.log(data);
});

// å¯ä¸å†™
readerStream.on('error', (err) => {
   console.log(err.stack);
});
```

![](https://pic4.zhimg.com/v2-27df92b3fb8544657ce2f86361251787_b.jpg)

è¯»æ–‡ä»¶çš„ä»£ç æˆ‘ä»¬å·²ç»å†™å®Œäº†ï¼Œç°åœ¨æˆ‘ä»¬å°è¯•è¿è¡Œä¸€ä¸‹ï¼š

ç»ˆç«¯è¿›å…¥åˆ°è¯¥æ–‡ä»¶å¤¹ä¸‹ï¼Œé”®å…¥ï¼š`node replace.js`, ä¸å‡ºæ„å¤–çš„è¯æ–‡ä»¶çš„å†…å®¹å·²ç»å®Œæ•´çš„å±•ç¤ºåœ¨ç»ˆç«¯ä¸Šäº†ã€‚

## ä¸‰ã€åˆ—å‡ºæ–‡ä¸­çš„æ‰€æœ‰ä¸­æ–‡å†…å®¹

åœ¨ `data` ä¸Šè¿›è¡Œæ•°æ®çš„å¤„ç†ï¼Œæˆ‘ä»¬è¦é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼å°†æ–‡ä¸­çš„ä¸­æ–‡å–å‡ºæ¥ã€‚åœ¨ä¸Šé¢çš„ä»£ç ä¸Šè¿›è¡Œä¿®æ”¹ï¼š

```js
readerStream.on('data', (chunk) => {
  const reg = /[\u4e00-\u9fa5]/g;
  while(list = reg.exec(chunk)) {
    console.log(list[0]);
  }
})
```

![](https://pic1.zhimg.com/v2-67b6bc7a1b52689f1b18b38c5d2895cc_b.jpg)

å¥½äº†ç°åœ¨æˆ‘ä»¬å·²ç»æŠŠæ‰€æœ‰çš„ä¸­æ–‡å…¨éƒ¨å–å‡ºæ¥äº†ï¼Œå¦‚æœæˆ‘ä»¬çš„éœ€æ±‚æ˜¯åˆ é™¤ä¸­æ–‡çš„è¯ï¼Œæˆ‘ä»¬åªéœ€è¦å°†è¿™äº›ä¸­æ–‡åˆ é™¤å³å¯ã€‚

å¦‚æœæ˜¯ç¿»è¯‘æˆè‹±æ–‡çš„è¯ï¼Œæ€»ä¸èƒ½ä¸€ä¸ªå­—ä¸€ä¸ªå­—çš„ç¿»è¯‘å§ï¼Ÿ

æ‰€ä»¥éœ€è¦æˆ‘ä»¬å°†è¿™ä¸ªä¸­æ–‡åˆ†ç±»å‡ºæ¥ï¼Œè¯¥æ˜¯è¯ç»„çš„å°±å­˜æˆè¯ç»„ï¼Œè¯¥æ˜¯å¥å­çš„å°±å­˜æˆå¥å­ï¼Œç”¨ä¸€ä¸ªæ•°ç»„æ¥è¿›è¡Œå­˜æ”¾ã€‚

æˆ‘çš„æ–¹å¼æ˜¯é€šè¿‡æ¯ä¸ªå­—çš„ç´¢å¼•è¿›è¡Œåˆ¤æ–­ã€‚è·å–åˆ°ä¸­æ–‡ä¸å‰ä¸€ä¸ªä¸­æ–‡ç´¢å¼•ç›¸æ¯”æ˜¯å¦æ˜¯ç›¸é‚»å…³ç³»ï¼Œå¦‚æœæ˜¯ï¼Œå°±ä¸èƒ½æ‹†å¼€æ¥ï¼Œåº”è¯¥ç»„æˆä¸€ä¸ªè¯è¯­æˆ–è€…å¥å­è¿›è¡Œå­˜å‚¨(å¯èƒ½å°ä¼™ä¼´çœ‹ä¸æ‡‚ï¼Œä½ ä»¬ç›´æ¥åˆ†æä»£ç å§ï½)

å¦‚æœæœ‰æ›´ä¼˜çš„æ–¹æ³•ï¼Œå°ä¼™ä¼´å¯ä»¥è‡ªå·±å°è¯•å“ˆï½

```js
readerStream.on('data', (chunk) => {

  var reg = /[\u4e00-\u9fa5]/g;
  let index = 0;
  let termList = [];    // éå†è·å–åˆ°çš„ä¸­æ–‡æ•°ç»„
  let term = '';
  data = chunk;

  while (list = reg.exec(chunk)) {
    if ((list.index !== index + 1) && term) {
      termList.push(term);
      term = '';
    }
    term += list[0];
    index = list.index;
  }
  termList.push(term);
  console.log(termList);    // æ‰“å°ä¸­æ–‡æ•°æ®
})
```

![](https://pic4.zhimg.com/v2-688d2e4eba965f133128023f6198ebc7_b.jpeg)

é€šè¿‡ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬å°±å·²ç»æŠŠè¯ç»„ï¼Œå¥å­ç­‰åŒºåˆ†å‡ºæ¥äº†ã€‚ç»ˆç«¯ä¸Šå°±èƒ½çœ‹åˆ°æ•°æ® `[ 'åŠ å¯†', 'å¦‚æœè¿™æ˜¯ä¸€æ®µè¯', 'å¹¶ä¸”è¿˜æœ‰æ ‡ç‚¹ç¬¦å·', 'åŠ å¯†æŠ¥é”™', 'è§£å¯†', 'è§£å¯†æŠ¥é”™' ]`ã€‚

ç¿»è¯‘çš„åŠŸèƒ½æˆ‘ä»¬æ”¾åˆ°ä¸‹ä¸ªæ¨¡å—å»è¯´ï¼Œæˆ‘ä»¬ç°åœ¨å…ˆæŠŠè·å–åˆ°çš„ä¸­æ–‡å†…å®¹æ›¿æ¢æˆéšæ„çš„å†…å®¹ã€‚

## å››ã€æ›¿æ¢ä¸­æ–‡

åˆ›å»ºä¸€ä¸ªå¯ä»¥å†™å…¥çš„æµï¼Œå°†æŸ¥è¯¢å‡ºæ¥çš„ä¸­æ–‡æ›¿æ¢æˆéšä¾¿çš„å­—ç¬¦ã€‚

```js
// åˆ›å»ºä¸€ä¸ªå¯ä»¥å†™å…¥çš„æµï¼Œå†™å…¥åˆ°æ–‡ä»¶ replaceDesUtils.ts ä¸­
let writerStream = fs.createWriteStream('replaceDesUtils.ts');

readerStream.on('data', (chunk) => {

  var reg = /[\u4e00-\u9fa5]/g;
  let index = 0;
  let termList = [];    // éå†è·å–åˆ°çš„ä¸­æ–‡æ•°ç»„
  let term = '';

  while (list = reg.exec(chunk)) {
    ...çœç•¥
  }
  if(termList && termList.length) {
    termList.map(item => {
      data = data.replace(item, '112233');      // è‡³æ­¤ï¼Œå·²ç»å°†ä¸­æ–‡å…¨éƒ¨è¿›è¡Œæ›¿æ¢
    })
  }

  writerStream.end(data); // å°†æ›¿æ¢åçš„æ–‡ä»¶å†™å…¥åˆ° replaceDesUtils.ts ä¸­å»
})
```

ç°åœ¨å°±å¯ä»¥å‘ç°å½“å‰åŒ…ä¸‹å¤šäº†ä¸€ä¸ª `replaceDesUtils.ts` æ–‡ä»¶ï¼Œå¿«æ‰“å¼€çœ‹çœ‹æ˜¯å¦æˆåŠŸäº†å§ã€‚

## äº”ã€å®ç°ç¿»è¯‘åŠŸèƒ½

åœ¨è°ƒç”¨ç¿»è¯‘çš„æ¥å£ä¸Šï¼Œå‚è€ƒäº†[åŸºäºnodejså®ç°ä¸€ä¸ªæœ‰é“è¯å…¸ç¿»è¯‘å™¨](https://www.jianshu.com/p/4d5086f0dc52) ç™¾åº¦ä¸Šçš„ä¸€ä¸ªæ•™ç¨‹æ–‡æ¡£ï¼Œå°ä¼™ä¼´ä»¬å¯ä»¥åšå‚è€ƒã€‚

æˆ‘ç²—ç•¥è¯´ä¸‹åˆ›å»ºçš„æ­¥éª¤(é‡Œå¤´æœ‰50å…ƒçš„é¢åº¦ï¼Œå¤Ÿæˆ‘ä»¬å†™ demo æµ‹è¯•ç”¨å°±æ˜¯äº†ï½)ï¼š

+   æ‰“å¼€[æœ‰é“æ™ºäº‘](https://ai.youdao.com/)æ³¨å†Œä¸‹è´¦å·
+   ç™»å½•ååœ¨å·¦è¾¹çš„ `tab` ä¸Šæ‰¾åˆ° `è‡ªç„¶è¯­è¨€ç¿»è¯‘-ç¿»è¯‘å®ä¾‹`ï¼Œåˆ›å»ºæ–°çš„å®ä¾‹ï¼Œé€‰æ‹©`æ–‡æœ¬ç¿»è¯‘`(æˆ–è€…ä½ å¯ä»¥é€‰æ‹©å…¶ä»–çš„ç±»å‹ï¼Œæˆ‘åªå°è¯•äº†`æ–‡æœ¬ç¿»è¯‘`)
+   æ‰“å¼€å·¦è¾¹ `tab` ä¸Š`åº”ç”¨ç®¡ç†-æˆ‘çš„åº”ç”¨`ï¼Œåˆ›å»ºæ–°çš„åº”ç”¨ï¼Œ`æ¥å…¥ç±»å‹` é€‰æ‹© `API`, ç‚¹å‡»ä¸‹ä¸€æ­¥åç»‘å®šåˆšåˆ›å»ºçš„å®ä¾‹ã€‚
+   æŸ¥çœ‹åº”ç”¨è¯¦æƒ…é‡Œå°±æœ‰ `åº”ç”¨ID` å’Œ `åº”ç”¨å¯†é’¥` è¿™ä¸¤ä¸ªå­—æ®µï¼Œåˆ†åˆ«å¯¹åº”ä¸€ä¼šéœ€è¦ç”¨åˆ°çš„ `appKey` å’Œ `secretKey`.

![](https://pic1.zhimg.com/v2-3861f8f34f5f98288bee20bb9cd3ab14_b.jpg)

æ¥ä¸‹æ¥åœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºä¸€ä¸ª `translator.js` æ–‡ä»¶ï¼Œç›´æ¥ copy [åŸºäºnodejså®ç°ä¸€ä¸ªæœ‰é“è¯å…¸ç¿»è¯‘å™¨](https://www.jianshu.com/p/4d5086f0dc52)è¿™é‡Œçš„ä»£ç å°±è¡Œã€‚

![](https://pic2.zhimg.com/v2-5c377c120a8d6f80a1f6d4c8b1af3115_b.jpg)

ä½†æ˜¯è¿™ä¸ªæ–‡ä»¶æœ‰ä¸€äº›éœ€è¦ç”¨åˆ°çš„åº“æˆ‘ä»¬æ²¡æœ‰ã€‚éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å®‰è£…ä¸€ä¸‹ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š

+   1ã€åœ¨å½“å‰åŒ…ä¸‹åˆ›å»ºä¸€ä¸ª `package.json` æ–‡ä»¶ï¼Œå¤åˆ¶ä¸€ä¸‹çš„ä»£ç ï¼š

```json
{
  "dependencies": {
    "request": "^2.88.0",
    "request-promise": "^4.2.5"
  }
}
```

+   2ã€ç„¶ååœ¨ç»ˆç«¯ä¸Šæ‰§è¡Œï¼š`npm i` æˆ–è€… `yarn`ï¼Œè£…ä¸Šæˆ‘ä»¬éœ€è¦çš„åº“ã€‚

å¥½äº†ç»§ç»­åœ¨ `replace.js` ç¼–å†™æˆ‘ä»¬çš„ä»£ç ï¼š

+   å¼•å…¥ç¿»è¯‘çš„æ–‡ä»¶ï¼Œå¹¶å®ä¾‹åŒ–
+   è®¾ç½®ç¿»è¯‘çš„é…ç½®
+   ç¼–å†™å…¬å…±æ–¹æ³•ï¼Œè¿›è¡Œç¿»è¯‘(å°ä¼™ä¼´å¦‚æœå¯¹ `Promise` ä¸å¤ªç†è§£æˆ‘ä¸‹æ–‡æœ‰è§£é‡Šå•Šå“ˆï½)
+   å°†ä¸­æ–‡è¿›è¡Œç¿»è¯‘å¹¶å†™å…¥æ–‡æ¡£ä¸­

```js
var Translator = require('./translator');

let translator = new Translator();

translator.config = {
  from: 'zh_CHS',
  to: 'EN',
  appKey: '*********',
  secretKey: '****************'
}

function translateString(str) {
  return new Promise(function (resolve, reject) {
    let resultStr = translator.translate(str);
    resolve(resultStr);
  })
}
```

è¿™é‡Œå…ˆè§£é‡Šä¸€ä¸‹ `translateString()` è¿™ä¸ªæ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬è°ƒç”¨çš„ç¿»è¯‘æ¥å£æ˜¯å¼‚æ­¥çš„ï¼Œå¦‚æœä¸ä½¿ç”¨ `Promise` ä¼šå­˜åœ¨å»¶è¿Ÿé—®é¢˜ã€‚

`Promise` æä¾›äº†ä¸€ç§å¼‚æ­¥æ‰§è¡Œæ¨¡å¼ã€‚

å…¶æä¾›çš„ä¸¤ä¸ªå‚æ•°å¯ä»¥ç†è§£ä¸º `return`, é€šè¿‡ `resolve` å°†éœ€è¦çš„æ•°æ®ä¼ é€’å‡ºå»ã€‚è¿™é‡Œæˆ‘ä»¬æ¥ä¸ªå°å°çš„æµ‹è¯•

```js
translateString('åŠ æ²¹').then(val => {
  console.log(val);
})
```

![](https://pic4.zhimg.com/v2-efc4fb72abd915dfb6b9e38f2b4802f3_b.jpg)

å‡ºæ¥çš„æ•°æ®æ˜¯ä¸€å¤§é•¿ä¸² `JSON` å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬å¯¹æ­¤è¿›è¡Œè½¬ä¹‰å’Œæˆªå–ä¸‹ã€‚`console.log(JSON.parse(val).translation)`

æ˜¯ä¸æ˜¯å‘ç°ç¿»è¯‘åçš„å†…å®¹å·²ç»è¢«æˆ‘ä»¬è·å–åˆ°äº†ã€‚

ç°åœ¨æˆ‘ä»¬ç»§ç»­æ¥ç¼–å†™ä»£ç ï¼š

```js
while (list = reg.exec(chunk)) {
  ...çœç•¥
}
termList.push(term);
console.log(termList);    // æ‰“å°ä¸­æ–‡æ•°æ®
translateString(termList).then(val => {
  let translation = JSON.parse(val).translation;  // è¿™é‡Œå¯ä»¥æ‰“å°ä¸€ä¸‹æ•°æ®ï¼Œç¿»è¯‘å‡ºæ¥çš„å†…å®¹ï¼Œå°±å¯ä»¥çŸ¥é“ä¸ºä»€ä¹ˆä¸‹æ–‡çš„ä»£ç è¦é‚£æ ·å†™äº†ã€‚
  let transList = [];     // ç¿»è¯‘åçš„æ•°ç»„

  if(translation[0] && translation[0].indexOf(',') !== -1) {

    transList = translation[0].split(', '); // é€—å·åé¢æœ‰ä¸ªç©ºæ ¼ä¸è¦æ¼äº†å“ˆ
    transList.map((item, index) => {
      console.log(termList[index], item);
      const res = data.replace(termList[index], item);
      data = res;
    })

    writerStream.write(data, 'UTF8');
    writerStream.end();
    console.log('å†™å…¥å®Œæˆ');
  }
})
```

![](https://pic4.zhimg.com/v2-0fc9cd6edabecc56abded75a5fedc7e7_b.jpg)

![](https://pic1.zhimg.com/v2-ec09eb43d5785beb3a036b97474d8350_b.jpg)

å¥½äº†å°ä¼™ä¼´ä»¬ï¼Œç°åœ¨æˆ‘ä»¬æ‰“å¼€ `replaceDesUtils.ts` çœ‹çœ‹æ•ˆæœå“ˆã€‚

åé¢çš„æ–‡ç« ä¼šç”¨åˆ° `express` è¿›è¡Œæ–‡æœ¬æ“ä½œï¼Œå¯ä»¥ä¸Šä¼ è‡ªå®šä¹‰çš„æ–‡ä»¶è¿›è¡Œç¿»è¯‘ã€‚

[å¼•ç”¨çš„æ–‡ç« ](https://zhuanlan.zhihu.com/p/101965933)